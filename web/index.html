<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>wind0 - Windows 10 Running on Browser</title>
    <link rel="stylesheet" href="emulator.css">
</head>
<body>
    <div class="emulator-container fullscreen">
        <!-- Toolbar removed - replaced by Dynamic Island -->
        <div class="emulator-toolbar hidden" id="toolbar" style="display: none;">
            <div class="toolbar-left">
                <div class="status-info">
                    <span id="statusIndicator" class="status-dot"></span>
                    <span id="statusText">Initializing...</span>
                </div>
            </div>
            <div class="toolbar-center">
                <h2>wind0 - Windows 10 Lite</h2>
            </div>
            <div class="toolbar-right">
                <button class="toolbar-btn" onclick="toggleFullscreen()" title="Fullscreen (F11)">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>
                    </svg>
                </button>
                <button class="toolbar-btn" onclick="showSettings()" title="Settings (S)">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m4.24-4.24l4.24-4.24"/>
                    </svg>
                </button>
                <button class="toolbar-btn" onclick="restartVM()" title="Restart (R)">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="23 4 23 10 17 10"></polyline>
                        <polyline points="1 20 1 14 7 14"></polyline>
                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                    </svg>
                </button>
                <button class="toolbar-btn" onclick="toggleDynamicIsland()" title="Toggle Dynamic Island (I)" id="toggleIslandBtn">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M12 6v6l4 2"></path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- VM Canvas Container -->
        <div class="vm-container">
            <div id="screen_container" class="screen-container">
                <canvas id="screen"></canvas>
                <div id="loadingOverlay" class="loading-overlay">
                    <div class="loading-content">
                        <div class="loading-spinner"></div>
                        <h3>Loading Windows 10 Lite...</h3>
                        <p id="loadingText">Initializing x86 emulator</p>
                        <div class="progress-bar">
                            <div id="progressFill" class="progress-fill"></div>
                        </div>
                        <p class="loading-note">This may take 30-60 seconds. Please be patient.</p>
                        <p class="loading-note" style="margin-top: 0.5rem; font-size: 0.75rem; opacity: 0.7;">
                            Press <kbd>Ctrl+Shift+T</kbd> to show toolbar
                        </p>
                    </div>
                </div>
                <div id="errorOverlay" class="error-overlay" style="display: none;">
                    <div class="error-content">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="12"></line>
                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                        </svg>
                        <h3>Error Loading Windows</h3>
                        <p id="errorMessage">Unable to load Windows image</p>
                        <div class="error-actions">
                            <button class="btn-primary" onclick="retryLoad()">Retry</button>
                            <button class="btn-secondary" onclick="showImageSelector()">Select Image</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settingsModal" class="modal">
            <div class="modal-backdrop" onclick="closeSettings()"></div>
            <div class="modal-container">
                <div class="modal-header">
                    <h2>Emulator Settings</h2>
                    <button class="modal-close" onclick="closeSettings()">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="memorySize">Memory (MB)</label>
                        <input type="number" id="memorySize" value="1536" min="512" max="2048" step="256">
                        <small>Windows 10 requires at least 1GB. More memory = better performance (requires restart)</small>
                    </div>
                    <div class="form-group">
                        <label for="cpuSpeed">CPU Speed</label>
                        <select id="cpuSpeed">
                            <option value="slow">Slow (Better compatibility)</option>
                            <option value="medium" selected>Medium (Balanced)</option>
                            <option value="fast">Fast (May cause issues)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="enableSound" checked>
                            Enable Sound
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="enableNetwork" checked>
                            Enable Network
                        </label>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-secondary" onclick="closeSettings()">Cancel</button>
                        <button class="btn-primary" onclick="applySettings()">Apply Settings</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Image Selector Modal -->
        <div id="imageModal" class="modal">
            <div class="modal-backdrop" onclick="closeImageModal()"></div>
            <div class="modal-container">
                <div class="modal-header">
                    <h2>Select Windows Image</h2>
                    <button class="modal-close" onclick="closeImageModal()">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="image-options">
                        <div class="image-option" onclick="loadPresetImage('windows10')">
                            <div class="image-icon">ü™ü</div>
                            <h3>Windows 10 Lite</h3>
                            <p>Windows 10 Lite Edition 19H2</p>
                            <small>1.1GB - Ready to use!</small>
                        </div>
                        <div class="image-option" onclick="loadCustomImage()">
                            <div class="image-icon">üìÅ</div>
                            <h3>Custom Image</h3>
                            <p>Upload your own Windows image</p>
                            <small>Supports .img, .iso, .vmdk formats</small>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="imageUrl">Or enter image URL:</label>
                        <input type="url" id="imageUrl" placeholder="https://example.com/windows.img">
                        <button class="btn-primary" onclick="loadFromUrl()">Load from URL</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Terms Modal (matches UI style) -->
        <div id="termsModal" class="terms-modal">
            <div class="terms-modal-backdrop"></div>
            <div class="terms-modal-container">
                <div class="terms-modal-header">
                    <h1>wind0</h1>
                    <p>Windows running on the browser</p>
                </div>
                
                <div class="terms-modal-content" id="termsContent">
                    <h2>Welcome to wind0</h2>
                    <p>
                        Welcome to wind0, Windows running on the browser.
                    </p>

                    <div class="warning-box">
                        <strong>‚ö†Ô∏è Performance Warning</strong>
                        This will make your device laggy, especially on lower end devices. You may not be able to do anything else while Windows is running.
                    </div>

                    <h2>System Requirements</h2>
                    <ul>
                        <li><strong>Memory:</strong> At least 4GB RAM recommended (2GB minimum)</li>
                        <li><strong>CPU:</strong> Modern multi-core processor recommended</li>
                        <li><strong>Browser:</strong> Latest version of Chrome, Firefox, Edge, or Safari</li>
                        <li><strong>Internet:</strong> Stable connection for downloading Windows image (1.1GB)</li>
                        <li><strong>Storage:</strong> Sufficient browser storage for caching</li>
                    </ul>

                    <h2>Performance Considerations</h2>
                    <p>
                        Running Windows in a browser is computationally intensive. The x86 emulation process requires significant CPU and memory resources. On lower-end devices, you may experience:
                    </p>
                    <ul>
                        <li>Slower system performance</li>
                        <li>Increased battery consumption</li>
                        <li>Browser tabs may become unresponsive</li>
                        <li>Other applications may slow down</li>
                    </ul>

                    <h2>Recommended Usage</h2>
                    <ul>
                        <li>Close unnecessary browser tabs and applications</li>
                        <li>Use a device with adequate resources</li>
                        <li>Ensure stable internet connection</li>
                        <li>Be patient during Windows boot (30-60 seconds)</li>
                        <li>Consider using a desktop/laptop for best experience</li>
                    </ul>

                    <h2>Technical Details</h2>
                    <p>
                        wind0 uses v86.js, a JavaScript-based x86 emulator, to run Windows 10 Lite Edition directly in your browser. The Windows image is loaded from archive.org and runs entirely client-side. No data is sent to external servers except for the initial image download.
                    </p>

                    <h2>Limitations</h2>
                    <ul>
                        <li>Emulated performance is slower than native Windows</li>
                        <li>Graphics are limited to VGA mode</li>
                        <li>Some Windows features may not work correctly</li>
                        <li>Network access requires WebSocket relay</li>
                        <li>Disk changes may not persist between sessions</li>
                    </ul>

                    <h2>Support & Feedback</h2>
                    <p>
                        Anyways, have fun with it and report any errors on the Github repo, or any suggestions.
                    </p>
                    <p>
                        We welcome your feedback, bug reports, and feature suggestions. Your input helps us improve wind0 and make Windows in the browser a better experience for everyone.
                    </p>

                    <h2>Disclaimer</h2>
                    <p>
                        wind0 is provided as-is for educational and demonstration purposes. The Windows 10 Lite Edition is used under appropriate licensing. We are not responsible for any system performance issues, data loss, or other consequences of using this software.
                    </p>

                    <div style="height: 2rem;"></div>
                </div>

                <div class="terms-modal-footer">
                    <div class="scroll-indicator" id="scrollIndicator">
                        Please scroll to the bottom to continue
                    </div>
                    <button class="accept-button" id="acceptButton" onclick="acceptTerms()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 6L9 17l-5-5"></path>
                        </svg>
                        I Understand and Accept
                    </button>
                </div>
            </div>
        </div>

        <!-- Load scripts in proper order -->
        <link rel="stylesheet" href="dynamic-island.css">
    <script src="libv86.js"></script>
    <script src="performance.js"></script>
    <script src="browserpod-integration.js"></script>
    <script src="fileio-client.js"></script>
    <script src="storage-manager.js"></script>
    <script src="filesystem-bridge.js"></script>
    <script src="dynamic-island.js"></script>
    <script>
        // Terms modal functions - defined first so they're available immediately
        function showTermsModal() {
            const modal = document.getElementById('termsModal');
            if (modal) {
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
        }
        
        function hideTermsModal() {
            const modal = document.getElementById('termsModal');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = '';
            }
        }
        
        function acceptTerms() {
            const acceptButton = document.getElementById('acceptButton');
            if (!acceptButton || !acceptButton.classList.contains('enabled')) {
                return;
            }
            
            // Save acceptance
            localStorage.setItem('wind0_terms_accepted', 'true');
            localStorage.setItem('wind0_terms_accepted_date', new Date().toISOString());
            
            // Hide modal and continue
            hideTermsModal();
            
            // Continue with initialization
            if (typeof waitForV86 === 'function') {
                waitForV86().then(() => {
                    // Load API client and emulator
                    const apiScript = document.createElement('script');
                    apiScript.src = 'api-client.js';
                    apiScript.async = true;
                    apiScript.onerror = () => console.log('API client not available, continuing without it');
                    document.head.appendChild(apiScript);
                    
                    const emulatorScript = document.createElement('script');
                    emulatorScript.src = 'emulator.js';
                    emulatorScript.async = true;
                    document.head.appendChild(emulatorScript);
                    
                    emulatorScript.onload = () => {
                        setTimeout(() => {
                            if (typeof initializeEmulator === 'function') {
                                initializeEmulator();
                            } else if (typeof WindowsEmulator !== 'undefined' && (typeof V86 !== 'undefined' || typeof V86Starter !== 'undefined')) {
                                window.emulator = new WindowsEmulator();
                            }
                        }, 100);
                    };
                });
            }
        }
        
        // Terms modal scroll detection
        document.addEventListener('DOMContentLoaded', () => {
            const termsContent = document.getElementById('termsContent');
            const acceptButton = document.getElementById('acceptButton');
            const scrollIndicator = document.getElementById('scrollIndicator');
            
            if (termsContent && acceptButton && scrollIndicator) {
                function checkScroll() {
                    const scrollTop = termsContent.scrollTop;
                    const scrollHeight = termsContent.scrollHeight;
                    const clientHeight = termsContent.clientHeight;
                    const scrollPercentage = (scrollTop + clientHeight) / scrollHeight;
                    
                    if (scrollPercentage >= 0.99) {
                        acceptButton.classList.add('enabled');
                        scrollIndicator.classList.remove('visible');
                    } else {
                        acceptButton.classList.remove('enabled');
                        scrollIndicator.classList.add('visible');
                    }
                }
                
                termsContent.addEventListener('scroll', checkScroll);
                checkScroll();
            }
        });
        
        // Load v86.js - use local file first (from git submodule)
        (function() {
            function loadV86() {
                return new Promise((resolve, reject) => {
                    // Try local file first (no CORS, fastest)
                    const sources = [
                        'libv86.js',           // Local file (no CORS) - PRIMARY
                        './libv86.js',         // Alternative path
                        '/libv86.js'           // Absolute path
                    ];
                    
                    let sourceIndex = 0;
                    
                    function tryNextSource() {
                        if (sourceIndex >= sources.length) {
                            reject(new Error('libv86.js not found. Please ensure the file exists in the web directory.'));
                            return;
                        }
                        
                        const script = document.createElement('script');
                        script.src = sources[sourceIndex];
                        script.async = false;  // Load synchronously to ensure it's ready
                        script.defer = false;
                        
                        let checkAttempts = 0;
                        const maxAttempts = 100; // 10 seconds
                        
                        script.onload = () => {
                            // Wait for V86Starter to be available
                                const checkV86 = setInterval(() => {
                                    if (typeof V86 !== 'undefined' || typeof V86Starter !== 'undefined') {
                                        clearInterval(checkV86);
                                        console.log('‚úì v86.js loaded successfully from:', sources[sourceIndex]);
                                        resolve();
                                    } else if (checkAttempts++ >= maxAttempts) {
                                        clearInterval(checkV86);
                                        console.warn('V86/V86Starter not available after load, trying next source');
                                        sourceIndex++;
                                        tryNextSource();
                                    }
                                }, 100);
                        };
                        
                        script.onerror = () => {
                            console.warn('‚úó Failed to load from:', sources[sourceIndex]);
                            sourceIndex++;
                            setTimeout(tryNextSource, 100);
                        };
                        
                        // Timeout after 15 seconds
                            setTimeout(() => {
                                if (script.parentNode && typeof V86 === 'undefined' && typeof V86Starter === 'undefined') {
                                    console.warn('Timeout loading from:', sources[sourceIndex]);
                                    script.onerror();
                                }
                            }, 15000);
                        
                        document.head.appendChild(script);
                    }
                    
                    tryNextSource();
                });
            }
            
                // Check if terms were accepted
                if (localStorage.getItem('wind0_terms_accepted') !== 'true') {
                    showTermsModal();
                    return;
                }
            
            // Wait for v86.js to load (it's loaded via script tag above)
            function waitForV86() {
                return new Promise((resolve, reject) => {
                    // Check for V86 or V86Starter
                    if (typeof V86 !== 'undefined' || typeof V86Starter !== 'undefined') {
                        console.log('‚úì v86.js already loaded');
                        resolve();
                        return;
                    }
                    
                    // Wait for it to load
                    let attempts = 0;
                    const maxAttempts = 100;
                    const checkV86 = setInterval(() => {
                        if (typeof V86 !== 'undefined' || typeof V86Starter !== 'undefined') {
                            clearInterval(checkV86);
                            console.log('‚úì v86.js loaded (V86 or V86Starter available)');
                            resolve();
                        } else if (attempts++ >= maxAttempts) {
                            clearInterval(checkV86);
                            // Try loading dynamically as fallback
                            loadV86().then(resolve).catch(reject);
                        }
                    }, 100);
                });
            }
            
            // Wait for v86.js, then load other scripts
            waitForV86().then(() => {
                // Load API client (optional, won't fail if not available)
                const apiScript = document.createElement('script');
                apiScript.src = 'api-client.js';
                apiScript.async = true;
                apiScript.onerror = () => console.log('API client not available, continuing without it');
                document.head.appendChild(apiScript);
                
                // Load emulator script
                const emulatorScript = document.createElement('script');
                emulatorScript.src = 'emulator.js';
                emulatorScript.async = true;
                document.head.appendChild(emulatorScript);
                
                emulatorScript.onload = () => {
                    // Initialize after everything is loaded
                    setTimeout(() => {
                        if (typeof initializeEmulator === 'function') {
                            initializeEmulator();
                        } else if (typeof WindowsEmulator !== 'undefined' && (typeof V86 !== 'undefined' || typeof V86Starter !== 'undefined')) {
                            window.emulator = new WindowsEmulator();
                        } else {
                            console.error('Failed to initialize emulator');
                            const errorMsg = document.getElementById('errorMessage');
                            const errorOverlay = document.getElementById('errorOverlay');
                            if (errorMsg) errorMsg.textContent = 'Failed to initialize emulator. Please refresh.';
                            if (errorOverlay) errorOverlay.style.display = 'flex';
                        }
                    }, 100);
                };
                
                emulatorScript.onerror = () => {
                    console.error('Failed to load emulator.js');
                    const errorMsg = document.getElementById('errorMessage');
                    const errorOverlay = document.getElementById('errorOverlay');
                    if (errorMsg) errorMsg.textContent = 'Failed to load emulator script. Please refresh.';
                    if (errorOverlay) errorOverlay.style.display = 'flex';
                };
            }).catch(err => {
                console.error('Failed to load v86.js:', err);
                const errorMsg = document.getElementById('errorMessage');
                const errorOverlay = document.getElementById('errorOverlay');
                const loadingOverlay = document.getElementById('loadingOverlay');
                
                if (loadingOverlay) {
                    loadingOverlay.style.display = 'none';
                }
                
                if (errorMsg) {
                    errorMsg.innerHTML = `
                        <strong>v86.js library failed to load</strong><br><br>
                        All CDN sources failed. This is likely due to CORS policy restrictions.<br><br>
                        <strong>Solution:</strong><br>
                        The v86.js file needs to be hosted locally to avoid CORS issues.<br><br>
                        <strong>To fix this:</strong><br>
                        1. Download libv86.js:<br>
                           <code>curl -L https://raw.githubusercontent.com/copy/v86/master/build/libv86.js -o libv86.js</code><br><br>
                        2. Place it in the web/ directory<br>
                        3. Redeploy to Vercel<br><br>
                        <small>Error: ${err.message}</small>
                    `;
                }
                if (errorOverlay) {
                    errorOverlay.style.display = 'flex';
                }
            });
        })();
        
        // Keyboard shortcuts (Dynamic Island handles UI)
        document.addEventListener('keydown', (e) => {
            // Settings with S
            if ((e.key === 's' || e.key === 'S') && !e.ctrlKey && !e.metaKey && !e.shiftKey) {
                if (typeof showSettings === 'function') {
                    e.preventDefault();
                    showSettings();
                }
            }
            
            // Dynamic Island toggle with I key
            if ((e.key === 'i' || e.key === 'I') && !e.ctrlKey && !e.shiftKey && !e.altKey && !e.metaKey) {
                e.preventDefault();
                toggleDynamicIsland();
                return;
            }
            
            // Restart with R
            if ((e.key === 'r' || e.key === 'R') && !e.ctrlKey && !e.metaKey) {
                if (typeof restartVM === 'function') {
                    e.preventDefault();
                    if (confirm('Restart Windows VM?')) {
                        restartVM();
                    }
                }
            }
            
            // F11 for fullscreen
            if (e.key === 'F11') {
                e.preventDefault();
                toggleFullscreen();
            }
            
            // Esc to exit fullscreen
            if (e.key === 'Escape') {
                if (document.fullscreenElement) {
                    document.exitFullscreen();
                }
            }
        });
        
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.log('Fullscreen not available:', err);
                });
            } else {
                document.exitFullscreen();
            }
        }
        
        // Dynamic Island toggle
        let dynamicIslandInstance = null;
        function toggleDynamicIsland() {
            if (dynamicIslandInstance) {
                dynamicIslandInstance.toggle();
            } else if (window.emulator && window.emulator.dynamicIsland) {
                dynamicIslandInstance = window.emulator.dynamicIsland;
                dynamicIslandInstance.toggle();
            }
        }

        // Initialize dynamic island after emulator loads
        setTimeout(() => {
            if (window.emulator && window.emulator.dynamicIsland) {
                dynamicIslandInstance = window.emulator.dynamicIsland;
            }
        }, 1000);
    </script>
</body>
</html>
